#!/usr/bin/env bash

# A script to build and install the C++ library

set -eu -o pipefail

# parse arguments
# -------------------------------------------------------------------
arg() { echo "$1" | sed "s/^${2-[^=]*=}//" | sed "s/:/;/g"; }

prefix=""
build_type="Release"
r_build="OFF"

while test $# != 0; do
  case "$1" in
  --prefix=*) prefix=$(arg "$1");;
  --enable-debug) build_type="Debug";;
  --r-build) r_build="ON";;
  esac
  shift
done

# find number of cpus
# -------------------------------------------------------------------
if [ "$(uname)" == "Darwin" ]; then
    nproc=$(sysctl -n hw.ncpu)
else
    nproc=$(nproc)
fi

# set extra cmake options
# -------------------------------------------------------------------
extra_opts=""
if [ "${build_type}" == "Debug" ]; then
  # Debug build: build TileDB from source with debug enabled
  extra_opts+=" -DFORCE_EXTERNAL_TILEDB=ON -DDOWNLOAD_TILEDB_PREBUILT=OFF"
elif [ "$(uname -m)" == "aarch64" ]; then
  # build on arm: build TileDB from source
  extra_opts=+" -DFORCE_EXTERNAL_TILEDB=ON -DDOWNLOAD_TILEDB_PREBUILT=OFF"
fi

# NOTE: set to true to debug the cmake build
if false; then
  # Debug note: this is _incredibly_ helpful in that it reveals the actual compile lines etc which
  # make itself shows by default but which cmake-driven make hides by default. Use this for any
  # non-trivial cmake debugging.
  extra_opts+=" -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON"

  # TILEDB_WERROR=OFF is necessary to build core with XCode 14; doesn't hurt for XCode 13.
  extra_opts+=" -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON -DTILEDB_WERROR=OFF -DTILEDBSOMA_ENABLE_WERROR=OFF"
  
  # Also (pro-tip), set nproc=1 to get a more deterministic ordering of output lines.
  nproc=1
fi

if [ -n "${prefix}"  ]; then 
  extra_opts+=" -DCMAKE_INSTALL_PREFIX=${prefix} -DOVERRIDE_INSTALL_PREFIX=OFF"
fi

if [ "${r_build}" == "ON" ]; then 
  extra_opts+=" -DTILEDBSOMA_BUILD_R=${r_build}"
fi

# run cmake
# -------------------------------------------------------------------
echo "Building ${build_type} build"
echo -e "${extra_opts}"

# cd to the top level directory of the repo
cd "$(git rev-parse --show-toplevel)"

rm -rf build
mkdir -p build
cmake -B build -S libtiledbsoma -DCMAKE_BUILD_TYPE=${build_type} ${extra_opts}
cmake --build build -j ${nproc}
cmake --build build --target install-libtiledbsoma

# Skip unit test build when building for R
if [ "${r_build}" == "OFF" ]; then
  cmake --build build/libtiledbsoma --target build_tests -j ${nproc}
fi
