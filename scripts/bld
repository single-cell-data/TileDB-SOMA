#!/usr/bin/env bash

# A script to build and install the C++ library

BUILD_TYPE=${1:-Release} # default to Release build
echo
echo ================================================================
echo SCRIPTS/BLD "BUILD_TYPE ${BUILD_TYPE}"
echo ================================================================

set -eu -o pipefail

# cd to the top level directory of the repo
cd $(git rev-parse --show-toplevel)
echo
echo ================================================================
echo SCRIPTS/BLD PWD
pwd
echo ================================================================

# set env for pybind11 cmake
export pybind11_DIR=$(python -m pybind11 --cmakedir)
echo
echo ================================================================
echo SCRIPTS/BLD PYBIND11 DIR=$pybind11_DIR
echo ================================================================

# remove existing build files
echo
echo ================================================================
echo SCRIPTS/BLD CLEAN
echo ================================================================
rm -rf build dist
rm -f apis/python/src/tiledbsoma/libtiledb.*
rm -f apis/python/src/tiledbsoma/libtiledbsoma.*

if [ $(uname) = "Darwin" ]; then
    nproc=$(sysctl -n hw.ncpu)
else
    nproc=$(nproc)
fi
# XXX TEMP
nproc=1
# XXX TEMP
echo
echo ================================================================
echo SCRIPTS/BLD NPROC $nproc
echo ================================================================

if [ $BUILD_TYPE == "Debug" ]; then
  # Debug build: build TileDB from source with debug enabled
  EXTRA_OPTS="-DFORCE_EXTERNAL_TILEDB=ON -DDOWNLOAD_TILEDB_PREBUILT=OFF"
elif [ $(uname -m) = "aarch64" ]; then
  # build on arm: build TileDB from source
  EXTRA_OPTS="-DFORCE_EXTERNAL_TILEDB=ON -DDOWNLOAD_TILEDB_PREBUILT=OFF"
else
  #EXTRA_OPTS=""
  EXTRA_OPTS="-DCMAKE_VERBOSE_MAKEFILE:BOOL=ON"
fi

mkdir -p build

echo
echo ================================================================
echo SCRIPTS/BLD MAKEMAKE
echo cmake -B build -S libtiledbsoma -DCMAKE_BUILD_TYPE=${BUILD_TYPE} ${EXTRA_OPTS}
cmake -B build -S libtiledbsoma -DCMAKE_BUILD_TYPE=${BUILD_TYPE} ${EXTRA_OPTS}
echo ================================================================

echo
echo ================================================================
echo SCRIPTS/BLD MAKEBIN
echo cmake --build build -j $nproc
cmake --build build -j $nproc
echo ================================================================

echo
echo ================================================================
echo SCRIPTS/BLD LOOK FOR SPDLOG.H
find . -follow -name spdlog.h -ls
echo ================================================================

echo
echo ================================================================
echo SCRIPTS/BLD MAKETEST
echo cmake --build build --target install-libtiledbsoma
cmake --build build --target install-libtiledbsoma
echo ================================================================
