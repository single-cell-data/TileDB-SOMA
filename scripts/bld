#!/usr/bin/env bash

# A script to build and install the C++ library

BUILD_TYPE=${1:-Release} # default to Release build
echo "Building ${BUILD_TYPE} build"

set -eu -o pipefail

# cd to the top level directory of the repo
cd $(git rev-parse --show-toplevel)

# set env for pybind11 cmake
export pybind11_DIR=$(python -m pybind11 --cmakedir)

# remove existing build and install directories
rm -rf build dist

if [ $(uname) = "Darwin" ]; then
    mkdir -p build
    nproc=$(sysctl -n hw.ncpu)
else
    nproc=$(nproc)
fi

# add options for TileDB debug build
if [ $BUILD_TYPE == "Debug" ]; then
  EXTRA_OPTS="-DFORCE_EXTERNAL_TILEDB=ON -DDOWNLOAD_TILEDB_PREBUILT=OFF -DTILEDB_S3=OFF"
else
  EXTRA_OPTS=""
fi

cmake -B build -S libtiledbsc -DCMAKE_BUILD_TYPE=${BUILD_TYPE} ${EXTRA_OPTS}
cmake --build build --target check-format
cmake --build build -j $nproc
cmake --build build --target install-libtiledbsc
