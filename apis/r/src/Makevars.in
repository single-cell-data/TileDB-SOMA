CXX_STD = CXX17

## We need the TileDB Headers, and for macOS aka Darwin need to set minimum version 10.14 for macOS.
## Our build assumes C++ libtiledbsoma in /usr/local/include and /usr/local/lib. Here we explicitly
## add -I and -L for those, since while some compilers add these paths implicitly, others do not.
PKG_CPPFLAGS = -Wno-deprecated-declarations -I. -I../inst/include/ -I/usr/local/include -L/usr/local/lib @tiledb_include@ @cxx17_macos@ -Iinclude

## We also need the TileDB library
PKG_LIBS = @cxx17_macos@ -ltiledbsoma @tiledb_libs@ @tiledb_rpath@

all: $(SHLIB)
        # If we are:
        #  - on macOS aka Darwin which needs this
        #  - the library is present (implying non-system library use)
        # then let us call install_name_tool
        #
        # Pro-tip: here you can run things like `otool -L tiledbsoma.so`, `ls ../inst`, etc. but
        # any attempted debug output will only be visible at the terminal if the R build fails.
        #
        # Note: we hard-code /usr/local/lib location for libtiledbsoma.so/dylib since this
        # is likewise hard-coded in our CI build.
        #
	@if [ `uname -s` = 'Darwin' ] && [ -f tiledbsoma.so ]; then \
	    if [ -f ../inst/tiledb/lib/libtiledb.dylib ] ; then \
	        install_name_tool -change libz.1.dylib @rpath/libz.1.dylib ../inst/tiledb/lib/libtiledb.dylib; \
	    fi; \
	    install_name_tool -add_rpath /usr/local/lib tiledbsoma.so; \
	fi
