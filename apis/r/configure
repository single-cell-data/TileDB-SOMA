#!/bin/sh

## This allow for standard CRAN override preference for both a settable R_HOME
## with fallback to query R in $PATH for the value it has so it works both
## explicitly or implicitly from the running R instance
: ${R_HOME=`R RHOME`}
if test -z "${R_HOME}"; then
    echo Could not determine R_HOME.
    exit 1
fi

### for single-cell-data/apis/r repo, consider completing sources
if test -f src/lib/libtiledbsoma.a; then
    echo "** static library present"
else
    echo "** no static library present"
    ## check for cmake, needed to build from source
    have_cmake=`which cmake`
    if [ "x${have_cmake}" = "x" ]; then
        echo "** cmake is required, but not in the path, exiting"
        exit 1
    fi
    if test -d ../../libtiledbsoma; then
        ## if in git repo, use build script
        (cd ../../; make prefix=apis/r/src r-build > apis/r/src/cmake_log.txt; )
        echo "** static library made; build log in 'src/cmake_log.txt'"
    elif test -d src/libtiledbsoma; then
        ## else with sources build by hand
        cd src
        mkdir -p build
        cmake -B build -S libtiledbsoma -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=. -DOVERRIDE_INSTALL_PREFIX=OFF -DTILEDBSOMA_BUILD_R=ON > cmake_log.txt
        cmake --build build -j 2 >> cmake_log.txt
        cmake --build build --target install-libtiledbsoma >> cmake_log.txt
        rm -rf build
        cd ..
        echo "** static library made; NO build log in 'src/cmake_log.txt'"
    else
        echo "** no sources, exiting"
        exit 1
    fi

    ## TODO: Case when we do not build in the git repo
fi

## check for tiledb-r 0.18.*. In DESCRIPTION we can pin only a minimum version, not a maximum.
Rscript -e 'q(save="no", status=if(packageVersion("tiledb") >= "0.18.0" && packageVersion("tiledb") < "0.19.0") FALSE else TRUE)'
if [ $? -ne 0 ]; then
    actual=`Rscript -e 'packageVersion("tiledb")'`
    echo "** need tiledb-r 0.18.*; got $actual -- exiting"
    exit 1
fi

## look for tiledb core library and either use system library or download build
have_tiledb="false"

## check for pkg-config and use it to inquire about tiledb build options
pkg-config --version >/dev/null 2>&1
if [ $? -eq 0 ]; then
    pkg-config --exists tiledb
    if [ $? -eq 0 ]; then
        pkgcflags=`pkg-config --cflags tiledb`
        pkglibs=`pkg-config --libs tiledb`
        archincl=`${R_HOME}/bin/Rscript -e 'cat("-I", system.file("include", package="arch"), sep="")'`

        ## substitute them in (leaving @tiledb_rpath@ and @cxx17_macos@ alone for now)
        sed -e "s|@tiledb_include@|$pkgcflags $archincl|" \
            -e "s|@tiledb_libs@|$pkglibs|" \
            -e "s|@tiledb_rpath@||" \
            -e "s|@cxx17_macos@||" \
            src/Makevars.in > src/Makevars

        have_tiledb="true"
        echo "** updated src/Makevars for system library via pkg-config"
    fi
fi

if [ x"${have_tiledb}" = x"false" ]; then
    ${R_HOME}/bin/Rscript tools/get_tarball.R
fi
