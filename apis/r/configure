#!/bin/sh

## This allow for standard CRAN override preference for both a settable R_HOME
## with fallback to query R in $PATH for the value it has so it works both
## explicitly, implicitly from the running R instance or by pointing at alternate
## build when multiple R versions are installed (as CRAN does and some users do)
: ${R_HOME=`R RHOME`}
if test -z "${R_HOME}"; then
    echo Could not determine R_HOME.
    exit 1
fi

## Check for pkg-config and use it to inquire about tiledb and tiledbsoma build options
pkg-config --version >/dev/null 2>&1
if [ $? -eq 0 ]; then
    pkg-config --exists tiledb tiledbsoma
    if [ $? -eq 0 ]; then
        pkgcflags=`pkg-config --cflags tiledb tiledbsoma`
        pkglibs=`pkg-config --libs tiledb tiledbsoma`

        ## substitute them in (leaving @tiledb_rpath@ and @cxx17_macos@ alone for now)
        sed -e "s|@tiledb_include@|$pkgcflags |" \
            -e "s|@tiledb_libs@|$pkglibs|" \
            -e "s|@tiledb_rpath@||" \
            -e "s|@cxx17_macos@||" \
            src/Makevars.in > src/Makevars

        echo "** updated src/Makevars for system library via pkg-config"
        exit 0
    fi
fi

## If we are still here `pkg-config` alone did not work.
## So download tiledb (pre-made) and tiledbsoma (source, for now; then build)
## This
${R_HOME}/bin/Rscript tools/get_tarballs.R
