#!/bin/sh

## This allow for standard CRAN override preference for both a settable R_HOME
## with fallback to query R in $PATH for the value it has so it works both
## explicitly or implicitly from the running R instance
: ${R_HOME=`R RHOME`}
if test -z "${R_HOME}"; then
    echo Could not determine R_HOME.
    exit 1
fi

## look for tiledb core library and either use system library or download build
have_tiledb="false"

## check for pkg-config and use it to inquire about tiledb build options
pkg-config --version >/dev/null 2>&1
if [ $? -eq 0 ]; then
    pkg-config --exists tiledb
    if [ $? -eq 0 ]; then
        pkgcflags=`pkg-config --cflags tiledb`
        pkglibs=`pkg-config --libs tiledb`

        ## substitute them in (leaving @tiledb_rpath@ and @cxx17_macos@ alone for now)
        sed -e "s|@tiledb_include@|$pkgcflags |" \
            -e "s|@tiledb_libs@|$pkglibs|" \
            -e "s|@tiledb_rpath@||" \
            -e "s|@cxx17_macos@||" \
            src/Makevars.in > src/Makevars

        have_tiledb="true"
        echo "** updated src/Makevars for system library via pkg-config"
    fi
fi

if [ x"${have_tiledb}" = x"false" ]; then
    ${R_HOME}/bin/Rscript tools/get_tarball.R
fi
