# Overview

This is the R implementation of the [SOMA API
specification](https://github.com/single-cell-data/SOMA/blob/main/abstract_specification.md).

# Installation

## Release packages

TileDB-SOMA releases can be installed from R-universe, which serves
macOS binaries and the source package for other Unix-like platforms.

``` r
install.packages('tiledbsoma', repos = c('https://tiledb-inc.r-universe.dev',
                                         'https://cloud.r-project.org'))
```

Installing from source on Unix-like platforms requires `cmake`, `git`,
and a recent-enough C++ compiler (`g++` version 10.\* or above).

Alternatively, tiledbsoma can be installed directly from
[Conda](https://anaconda.org/tiledb/r-tiledbsoma), which serves binaries
for multiple architectures.

``` bash
mamba install -c conda-forge -c tiledb r-tiledbsoma
```

*Note, we’re using `mamba` here as a drop-in replacement for `conda` to
accelerate the install process.*

## From source

To install the very latest tiledbsoma development version (our `main`
branch), use
[`remotes::install_github()`](https://cran.r-project.org/package=remotes/readme/README.html):

``` r
remotes::install_github("https://github.com/single-cell-data/TileDB-SOMA", subdir = "apis/r")
```

A note about the `fmt` and `spdlog` packages:

- If you encounter an install-time error like
  `undefined symbol: _ZTIN3fmt2v912format_errorE` then you should
  uninstall your systemversions of `fmt` and `spdlog`. On Linux, this
  means `dpkg -l | egrep "lib(spdlog|fmt)"` should now come up empty.
- If you encounter an install-time error like
  `fatal error: spdlog/spdlog.h: No such file or directory` you should
  additionally recursively remove `/usr/local/lib/cmake/spdlog`, since
  the system uninstall of `spdlog` fails to remove this properly.

### Requirements

- Source installation requires the [`tiledb` R
  package](https://github.com/TileDB-Inc/TileDB-R) – which in turn
  depends on either a local installation of [TileDB Core
  library](https://github.com/TileDB-Inc/TileDB) or the provided build
  artifacts.
- In general, source installation of TileDB Core and its packages
  requires `cmake` and `git` to be installed; these are common tools
  each operating system provides readily.
- All other R package dependencies are listed in the
  [DESCRIPTION](https://github.com/single-cell-data/TileDB-SOMA/blob/main/apis/r/DESCRIPTION)
  file and can be installed via *e.g.*
  `remotes::install_deps(".", dependencies=TRUE)` which will also
  install suggested packages. In order to build vignettes, `knitr` and
  `rmarkdown` are required (and will be installed), as is `testthat` for
  testing. If `testthat` is invoked directly then `pkgbuild` is also
  needed (but is not installed as not listed in `DESCRIPTION`).
- In addition, this R package also depends on the [`libtiledbsoma`
  library](https://github.com/single-cell-data/TileDB-SOMA/tree/main/libtiledbsoma)
  from this repository. It is either installed with the package (as
  described in the next section), or can be used as a system library (if
  one is found). A system installation can be provided by following the
  steps in the [`libtiledbsoma`
  directory](https://github.com/single-cell-data/TileDB-SOMA/tree/main/libtiledbsoma).

### Development setup

To set up and install from a local clone of this git repository:

- Clone this repository:
  `git clone https://github.com/single-cell-data/TileDB-SOMA.git`.
- Change into the R API package directory: `cd TileDB-SOMA/apis/r`.
- Optionally, clean the files in the repo: `./cleanup` (this is not
  needed the first time).
- Optionally, add on optional package with more more test data:
  `install.packages("pbmc3k.tiledb", repos="https://ghrr.github.io/drat")`.
- If you have edited any `src/*.cpp` files and changed any function
  signatures, then running `Rscript -e 'Rcpp::compileAttributes()'` will
  update the `Rcpp`-generated glue code.
- If you have changed any C++ function header documentation, run
  `Rscript -e 'roxygen2::roxygenise()'` to update the corresponding R
  files.
- Build the R package source tarball from the repository sources:
  `R CMD build .` (which will also include the `libtiledbsoma` source
  via a repository soft-link); other dependencies are required as
  described in the previous section).
- Optionally, check and test the package from the tarball skipping
  vignettes and manuals (which need `texlive` or equivalent):
  `R CMD check --no-vignettes --no-manual tiledbsoma_*.tar.gz`.
- Finally, install the package from the tarball:
  `R CMD INSTALL tiledbsoma_*.tar.gz`. During this installation presence
  of the two C++ libraries (TileDB Core, TileDB-SOMA) is tested for.
  TileDB Core builds can be downloaded as needed, and the TileDB-SOMA
  library is built if needed. (We plan to provide a downloadable
  artifact for it too.)

Once installed successfully, the package sources can be edited and
re-installed iteratively. The optional clean step ensures a full
rebuild, and the optional copy of `libtiledbsoma` ensures it is updated
too.

# Status

Please see <https://github.com/single-cell-data/TileDB-SOMA/issues>.

# Information for developers

Please see the [TileDB-SOMA
wiki](https://github.com/single-cell-data/TileDB-SOMA/wiki).

This `main` branch implements the [updated
specification](https://github.com/single-cell-data/SOMA/blob/main/abstract_specification.md).
Please also see the `main-old` branch for an implementation of the
[original
specification](https://github.com/single-cell-data/TileDB-SOMA/blob/main-old/spec/specification.md).

# Package index

## TileDB-SOMA

- [`ConfigList`](ConfigList.md) : A Configuration List

- [`IntIndexer`](IntIndexer.md) : The SOMA Re-Indexer

- [`PlatformConfig`](PlatformConfig.md) : Platform Configuration

- [`SOMAAxisQuery`](SOMAAxisQuery.md) : SOMA Axis Query

- [`SOMAAxisQueryResult`](SOMAAxisQueryResult.md) :

  `SOMAExperiment` Axis Query Result

- [`SOMACollection`](SOMACollection.md) : SOMA Collection

- [`SOMACollectionCreate()`](SOMACollectionCreate.md) : Create a SOMA
  Collection

- [`SOMACollectionOpen()`](SOMACollectionOpen.md) : Open a SOMA
  Collection

- [`SOMAContext`](SOMAContext.md) : SOMA Context

- [`SOMADataFrame`](SOMADataFrame.md) : SOMADataFrame

- [`SOMADataFrameCreate()`](SOMADataFrameCreate.md) : Create a SOMA Data
  Frame

- [`SOMADataFrameOpen()`](SOMADataFrameOpen.md) : Open a SOMA Data Frame

- [`SOMADenseNDArray`](SOMADenseNDArray.md) : SOMA Dense Nd-Array

- [`SOMADenseNDArrayCreate()`](SOMADenseNDArrayCreate.md) : Create a
  SOMA Dense ND Array

- [`SOMADenseNDArrayOpen()`](SOMADenseNDArrayOpen.md) : Open a SOMA
  Dense Nd Array

- [`SOMAExperiment`](SOMAExperiment.md) : SOMA Experiment

- [`SOMAExperimentAxisQuery`](SOMAExperimentAxisQuery.md) :

  `SOMAExperiment` Axis Query

- [`SOMAExperimentCreate()`](SOMAExperimentCreate.md) : Create a SOMA
  Experiment

- [`SOMAExperimentOpen()`](SOMAExperimentOpen.md) : Open SOMA Experiment

- [`SOMAMeasurement`](SOMAMeasurement.md) : SOMA Measurement

- [`SOMAMeasurementCreate()`](SOMAMeasurementCreate.md) : Create a SOMA
  Measurement

- [`SOMAMeasurementOpen()`](SOMAMeasurementOpen.md) : Open SOMA
  Measurement

- [`SOMAOpen()`](SOMAOpen.md) : Open a SOMA Object

- [`SOMASparseNDArray`](SOMASparseNDArray.md) : SOMA Sparse Nd-Array

- [`SOMASparseNDArrayCreate()`](SOMASparseNDArrayCreate.md) : Create a
  SOMA Sparse ND Array

- [`SOMASparseNDArrayOpen()`](SOMASparseNDArrayOpen.md) : Open a SOMA
  Sparse ND Array

- [`SOMATileDBContext`](SOMATileDBContext.md) : SOMA TileDB Context

- [`SparseReadIter`](SparseReadIter.md) : SOMA Read Iterator Over Sparse
  Matrices

- [`TableReadIter`](TableReadIter.md) : SOMA Read Iterator Over Arrow
  Tables

- [`list_datasets()`](example-datasets.md)
  [`extract_dataset()`](example-datasets.md)
  [`load_dataset()`](example-datasets.md) : SOMA Example Datasets

- [`get_default_context()`](get_default_context.md) : Get the Default
  SOMA Context

- [`matrixZeroBasedView`](matrixZeroBasedView.md) : Zero-based Wrapper
  for Sparse Matrices

- [`set_default_context()`](set_default_context.md) : Set the Default
  Global Context

- [`set_log_level()`](set_log_level.md) : Set TileDB-SOMA Logging Level

- [`show_package_versions()`](show_package_versions.md) : Display
  package versions

- [`tiledbsoma_stats_enable()`](tiledbsoma_stats.md)
  [`tiledbsoma_stats_disable()`](tiledbsoma_stats.md)
  [`tiledbsoma_stats_reset()`](tiledbsoma_stats.md)
  [`tiledbsoma_stats_dump()`](tiledbsoma_stats.md)
  [`tiledbsoma_stats_show()`](tiledbsoma_stats.md) : TileDB SOMA
  Statistics

- [`write_soma()`](write_soma.md) :

  Write a SOMA Object from an R Object

- [`write_soma(`*`<Seurat>`*`)`](write_soma.Seurat.md) :

  Write a
  [`Seurat`](https://satijalab.github.io/seurat-object/reference/Seurat-class.html)
  object to a SOMA

- [`write_soma(`*`<SingleCellExperiment>`*`)`](write_soma.SingleCellExperiment.md)
  :

  Write a `SingleCellExperiment` object to a SOMA

- [`write_soma(`*`<SummarizedExperiment>`*`)`](write_soma.SummarizedExperiment.md)
  :

  Write a `SummarizedExperiment` object to a SOMA

# Articles

### All vignettes

- [Querying a SOMA experiment](soma-experiment-queries.md):
- [SOMA objects overview](soma-objects.md):
- [Reading from SOMA objects](soma-reading.md):
- [SOMA shapes](soma-shapes.md):
- [Using PlatformConfig](UsingPlatformConfig.md):
