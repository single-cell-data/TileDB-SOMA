# Workflow to build distribution, and push to PyPI or TestPyPI

name: TileDB-SOMA Python Release

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/python-packaging.yml'
  release:
    types: [published]
  schedule:
    - cron: "42 9 * * *"

jobs:
  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout TileDB-SOMA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to fetch tags: https://github.com/actions/checkout/issues/2199
          fetch-tags: true  # Tags needed for python API version number

      - name: Install dependencies
        run: |
          pip install --upgrade 'build' 'scikit-build-core>=0.10.0' 'pybind11[global]>=2.10.0' 'cmake>=3.21,<4' 'setuptools>=70.1' 'setuptools-scm>=8.0.0'
          pip list

      - name: Build sdist
        run: python -m build --sdist apis/python


      - name: Upload sdist artifact to GitHub Actions storage
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: apis/python/dist/

  test_sdist:
    name: Test source distribution
    needs: build_sdist
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm, macos-15-intel, macos-15]
        python_version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
    steps:
      - name: Set up Python ${{ matrix.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python_version }}

      - name: "Setup for macOS"
        if: ${{ startsWith(matrix.os, 'macos-') == true }}
        run: |
          set -e pipefail
          brew update
          brew install automake llvm

      - name: Create custom vcpkg triplets for release builds
        run: |
          mkdir -p vcpkg_triplets
          
          # x64-linux-release
          cat > vcpkg_triplets/x64-linux-release.cmake << 'EOF'
          set(VCPKG_TARGET_ARCHITECTURE x64)
          set(VCPKG_CRT_LINKAGE dynamic)
          set(VCPKG_LIBRARY_LINKAGE dynamic)
          set(VCPKG_BUILD_TYPE release)
          set(VCPKG_CMAKE_SYSTEM_NAME Linux)
          EOF
          
          # arm64-linux-release
          cat > vcpkg_triplets/arm64-linux-release.cmake << 'EOF'
          set(VCPKG_TARGET_ARCHITECTURE arm64)
          set(VCPKG_CRT_LINKAGE dynamic)
          set(VCPKG_LIBRARY_LINKAGE dynamic)
          set(VCPKG_BUILD_TYPE release)
          set(VCPKG_CMAKE_SYSTEM_NAME Linux)
          EOF
          
          # x64-osx-release
          cat > vcpkg_triplets/x64-osx-release.cmake << 'EOF'
          set(VCPKG_TARGET_ARCHITECTURE x64)
          set(VCPKG_CRT_LINKAGE dynamic)
          set(VCPKG_LIBRARY_LINKAGE dynamic)
          set(VCPKG_BUILD_TYPE release)
          set(VCPKG_CMAKE_SYSTEM_NAME Darwin)
          set(VCPKG_OSX_ARCHITECTURES x86_64)
          set(VCPKG_OSX_DEPLOYMENT_TARGET "13.0")
          EOF
          
          # arm64-osx-release
          cat > vcpkg_triplets/arm64-osx-release.cmake << 'EOF'
          set(VCPKG_TARGET_ARCHITECTURE arm64)
          set(VCPKG_CRT_LINKAGE dynamic)
          set(VCPKG_LIBRARY_LINKAGE dynamic)
          set(VCPKG_BUILD_TYPE release)
          set(VCPKG_CMAKE_SYSTEM_NAME Darwin)
          set(VCPKG_OSX_ARCHITECTURES arm64)
          set(VCPKG_OSX_DEPLOYMENT_TARGET "13.0")
          EOF

      - name: Bootstrap vcpkg
        run: |
          if [ ! -d vcpkg ]; then
            git clone --depth 1 https://github.com/microsoft/vcpkg.git vcpkg
            ./vcpkg/bootstrap-vcpkg.sh
          fi
          
          echo "Copying triplets from ./vcpkg_triplets/ to vcpkg/triplets/"
          ls -la $GITHUB_WORKSPACE/vcpkg_triplets/*-release.cmake || echo "WARNING: No triplets found in ./vcpkg_triplets/"
          cp -v $GITHUB_WORKSPACE/vcpkg_triplets/*-release.cmake vcpkg/triplets/
          
          echo "Verifying triplets were copied:"
          ls -la vcpkg/triplets/*-release.cmake
          echo "Verifying Linux triplets have VCPKG_CMAKE_SYSTEM_NAME:"
          grep -H "VCPKG_CMAKE_SYSTEM_NAME" vcpkg/triplets/*-linux-release.cmake || echo "ERROR: Linux triplets missing VCPKG_CMAKE_SYSTEM_NAME"
          echo "VCPKG_ROOT=$GITHUB_WORKSPACE/vcpkg" >> $GITHUB_ENV
          echo "CMAKE_TOOLCHAIN_FILE=$GITHUB_WORKSPACE/vcpkg/scripts/buildsystems/vcpkg.cmake" >> $GITHUB_ENV

      - name: Set VCPKG_TARGET_TRIPLET
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-24.04" ]]; then
            echo "VCPKG_TARGET_TRIPLET=x64-linux-release" >> $GITHUB_ENV
          elif [[ "${{ matrix.os }}" == "ubuntu-24.04-arm" ]]; then
            echo "VCPKG_TARGET_TRIPLET=arm64-linux-release" >> $GITHUB_ENV
          elif [[ "${{ matrix.os }}" == "macos-15-intel" ]]; then
            echo "VCPKG_TARGET_TRIPLET=x64-osx-release" >> $GITHUB_ENV
          elif [[ "${{ matrix.os }}" == "macos-15" ]]; then
            echo "VCPKG_TARGET_TRIPLET=arm64-osx-release" >> $GITHUB_ENV
          fi
          
      - name: Download sdist artifact
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: apis/python/dist/

      - name: Install sdist artifact
        run: |
          echo $PWD
          pip install --verbose apis/python/dist/*.tar.gz

  build_wheels:
    name: ${{ matrix.python_name }}-${{ matrix.platform }} wheel
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python_name: ['cp39', 'cp310', 'cp311', 'cp312', 'cp313']
        os: [ubuntu-22.04, ubuntu-22.04-arm, macos-15-intel, macos-15]
        include:
          - platform: manylinux_x86_64
            os: ubuntu-22.04
          - platform: manylinux_aarch64
            os: ubuntu-22.04-arm
          - platform:  macosx_x86_64
            os: macos-15-intel
          - platform: macosx_arm64
            os: macos-15

    steps:
      - name: Checkout TileDB-SOMA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to fetch tags: https://github.com/actions/checkout/issues/2199
          fetch-tags: true # Tags needed for python API version number

      - name: "Setup for macOS"
        if: ${{ startsWith(matrix.os, 'macos-') == true }}
        run: |
          set -e pipefail
          brew update
          brew install automake llvm

      - name: Install cibuildwheel and dependencies
        run: |
          pip install --upgrade 'cibuildwheel>=2.19.0' 'scikit-build-core>=0.10.0' 'pybind11[global]>=2.10.0' 'cmake>=3.21,<4' 'setuptools>=70.1' 'setuptools-scm>=8.0.0'

      - name: Build wheels
        uses: pypa/cibuildwheel@v3.1.1
        with:
          package-dir: apis/python/
          output-dir: wheelhouse
        env:
          CIBW_BUILD: ${{ matrix.python_name }}-${{ matrix.platform }}
          CIBW_BUILD_VERBOSITY: 3
          # Platform-specific environment variables - note: paths are evaluated inside the container
          CIBW_ENVIRONMENT_LINUX: >
            VCPKG_TARGET_TRIPLET=${{ endsWith(matrix.platform, 'aarch64') && 'arm64-linux-release' || 'x64-linux-release' }}
            VCPKG_ROOT=/project/vcpkg
            CMAKE_TOOLCHAIN_FILE=/project/vcpkg/scripts/buildsystems/vcpkg.cmake
            VCPKG_FORCE_SYSTEM_BINARIES=1
          CIBW_ENVIRONMENT_MACOS: >
            VCPKG_TARGET_TRIPLET=${{ endsWith(matrix.platform, 'arm64') && 'arm64-osx-release' || 'x64-osx-release' }}
            CMAKE_OSX_ARCHITECTURES=${{ endsWith(matrix.platform, 'arm64') && 'arm64' || 'x86_64' }}
            MACOSX_DEPLOYMENT_TARGET=13.3
            VCPKG_ROOT="$(pwd)/vcpkg"
            CMAKE_TOOLCHAIN_FILE="$(pwd)/vcpkg/scripts/buildsystems/vcpkg.cmake"

      - name: Check wheel name
        run: ls -l ./wheelhouse/*.whl

      - name: Upload wheel-${{ matrix.python_name }}-${{ matrix.platform }}
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.python_name }}-${{ matrix.platform }}
          path: ./wheelhouse/*.whl

  test_wheels:
    name: "Smoke test ${{ matrix.python_version}}-${{ matrix.platform }} wheel"
    needs: build_wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python_version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
        os: [ubuntu-22.04, ubuntu-22.04-arm, macos-15-intel, macos-15]
        include:
          - platform: manylinux_x86_64
            os: ubuntu-22.04
          - platform: manylinux_aarch64
            os: ubuntu-22.04-arm
          - platform: macosx_x86_64
            os: macos-15-intel
          - platform: macosx_arm64
            os: macos-15
          - wheel_suffix: manylinux_2_28_x86_64
            os: ubuntu-22.04
          - wheel_suffix: manylinux_2_28_aarch64
            os: ubuntu-22.04-arm
          - wheel_suffix: macosx_13_0_x86_64
            os: macos-15-intel
          - wheel_suffix: macosx_13_0_arm64
            os: macos-15
          - python_name: "cp39"
            python_version: "3.9"
          - python_name: "cp310"
            python_version: "3.10"
          - python_name: "cp311"
            python_version: "3.11"
          - python_name: "cp312"
            python_version: "3.12"
          - python_name: "cp313"
            python_version: "3.13"
      fail-fast: false
    steps:
      - name: Set up Python ${{ matrix.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python_version }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: wheel-${{ matrix.python_name }}-${{ matrix.platform }}

      - name: Install wheel
        run: |
          set -x
          ls -lR
          WHL=$(find . -name 'tiledbsoma-*-${{ matrix.python_name }}-${{ matrix.python_name }}-*${{ matrix.wheel_suffix }}.whl')
          echo "WHL=$WHL"
          if [ -z "$WHL" ]; then echo "No wheel found"; exit 1; fi
          unzip -l $WHL
          pip install wheel
          pip install $WHL
          echo "WHL=$WHL" >> $GITHUB_ENV

      - name: Smoke test ${{ matrix.os }}
        run: python -c 'import tiledbsoma; print(tiledbsoma.pytiledbsoma.__file__); tiledbsoma.show_package_versions()'
        # TODO: more thorough local smoke test

      - name: Smoke test in docker
        if: ${{ matrix.os == 'ubuntu-24.04' }}
        run: |
          docker run -v $(pwd):/mnt python:${{ matrix.python_version }} bash -ec "
            apt-get -qq update && apt-get install -y python3-pip python3-wheel
            pip3 install /mnt/$WHL
            python3 -c 'import tiledbsoma; print(tiledbsoma.pytiledbsoma.__file__); tiledbsoma.show_package_versions()'
          "

  # Publish to TestPyPI upon user workflow request
  publish_test_pypi:
    name: Publish package to TestPyPI
    needs: [test_sdist, test_wheels]
    runs-on: ubuntu-24.04
    environment: test-pypi
    permissions:
      id-token: write
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
      - name: Create dist
        run: |
          set -x
          mkdir dist
          cp sdist/tiledbsoma-*.tar.gz wheel-*/*.whl dist
          ls -l dist
      - name: Publish packages to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages_dir: dist
          verbose: true

  # Publish to PyPI upon release.
  publish_pypi:
    name: Publish package to PyPI
    needs: [test_sdist, test_wheels]
    runs-on: ubuntu-24.04
    # Configuration: https://github.com/single-cell-data/SOMA/settings/environments
    environment: pypi
    # Configuration: https://pypi.org/manage/project/somacore/settings/publishing
    permissions:
      id-token: write
    if: github.event_name == 'release'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
      - name: Create dist
        run: |
          set -x
          mkdir dist
          cp sdist/tiledbsoma-*.tar.gz wheel-*/*.whl dist
          ls -l dist
      - name: Publish packages to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages_dir: dist
          verbose: true

  # File a bug report if anything fails, but don't file tickets for manual runs
  # -- only for scheduled ones.
  create_issue_on_fail:
    runs-on: ubuntu-24.04
    needs: [test_sdist, test_wheels, publish_test_pypi, publish_pypi]
    if: (failure() || cancelled()) && github.event_name != 'workflow_dispatch' && github.event_name != 'pull_request' && github.run_attempt == 1
    steps:
      - name: Checkout TileDB-SOMA `main`
        uses: actions/checkout@v4
      - name: Create Issue if Build Fails
        uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          filename: .github/workflows/failed-issue-template.md
          assignees: jp-dark, aaronwolen
          update_existing: true